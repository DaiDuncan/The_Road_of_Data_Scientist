# IP协议的作用与特点

- IP协议提供的是**无连接、不可靠**的数据报传输服务

- IP协议是一个支持异构网络互连的网络层协议

  - 异构性和可扩展性

    - IP协议通过对IP数据报的有效定义，以统一的IP数据报传输提供了对异构网络互连的支持，将各种网络技术在物理层和数据链路层的差异统一在IP协议之下，向传输层屏蔽了通信子网的差异。

    - 尤其是IP协议中所定义的IP寻址模式，有效实现了跨越不同LAN、MAN和WAN的主机寻址能力。

    - 正是这种对异构网络互连的强大支持能力，IP协议才成为当今最为主流的网络互连协议

  - 虚拟互联网络

    - 因特网在IP层采用了标准化协议，参加互连的计算机都使用相同的网际协议IP。

    - 因此可以将互连后的计算机网络看成一个虚拟互联网络。 

    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092440.jpeg)![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092447.jpeg)

    - 虚拟互连网络的意义

      - 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

      - 使用 IP 协议的虚拟互连网络可简称为 IP 网。

      - 使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。

  - 网络层的数字管道

    - 如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层的数字管道中传送。 

    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092454.jpeg)

- IP协议是一个点到点的网络层协议。

# IP数据报

- 图示
  - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092513.jpeg)

- 版本

  - 4bit

  - 指 IP 协议的版本目前的 IP 协议版本号为 4 (即 IPv4)

- 首部长度

  - 4 bit

  - 可表示的最大数值是 15 个单位(一个单位为 4 字节)

  - 因此 IP 的首部长度的最大值是 60 字节。

- 区分服务

  - 8bir，用来获得更好的服务

  - 在旧标准中叫做服务类型，但实际上一直未被使用过。

  - 1998 年这个字段改名为区分服务。

  - 只有在使用区分服务（DiffServ）时，这个字段才起作用。

  - 在一般的情况下都不使用这个字段

- 总长度

  - 16bit，指首部和数据之和的长度，

  - 单位为字节，因此数据报的最大长度为 65535 字节。

  - 总长度必须不超过最大传送单元 MTU。

- 标识

  - 16bit

  - 它是一个计数器，用来产生数据报的标识。

- 标志

  - 3bit，但目前只有两个标志位有意义。

  - 图示
    - ![img](https://api2.mubu.com/v3/document_image/eb5d9eb2-fd2c-4f2c-81f8-42f9d656b635-4644403.jpg)

  - MF (More Fragment) ：
    - 1 表示后面“还有分片”， 0 表示最后一个分片。

  - DF (Don‘t Fragment) ：
    - 0 允许分片，1不允许分片

- 片偏移

  - 13bit

  - 较长的分组在分片后，某片在原分组中的相对位置。

  - 片偏移以 8 个字节为偏移单位。

  - 【例5-1】 IP 数据报分片举例

    - 假定一个IP数据报的总长度为3620字节，其数据部分长度为3600字节(使用固定长度首部)，需要分片为长度不超过1420字节的数据报片。因首部固定长度部分为20字节，因此每个数据报分片的数据部分长度不能超过1400字节。于是分为3个数据报片，其数据部分的长度分别为1400， 1400和800字节。初始数据报的首部被复制为各数据报分片的首部，但必须修改有关字段的值。 

    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092521.jpeg)![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092524.jpeg)

- 生存时间

  - 8bit，记为 TTL (Time To Live)

  - 数据报在网络中可通过的路由器数的最大值。

- 协议

  - 8bit

  - 指出此数据报携带的数据使用何种协议

  - 以便目的主机的 IP 层将数据部分上交给哪个处理过程

  - 图示
    - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092532.jpeg)

- 首部检验和

  - 16bit

  - 只检验数据报的首部，不检验数据部分。

  - 这里不采用 CRC 检验码而采用简单的计算方法

  - 图示
    - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092541.jpeg)

- 源地址和目的地址
  - 都各占 4bit

- 可变部分

  - 可变部分就是一个选项字段

  - IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。

  - 选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。

  - 某些选项项目只需要1个字节，它只包括1个字节的选项代码。但还有些选项需要多个字节，这些选项一个个拼接起来，中间不需要有分隔符。

  - 目前，这些任选项定义如下：

    - ①安全和处理限制，用于军事领域；

    - ②记录路径，让每个路由器都记下它的IP地址；

    - ③时间戳（Time Stamp），让每个路由器都记下IP数据报经过每一个路由器的IP地址和当地时间；

    - ④宽松的源站路由（Loose Source Route），为数据报指定一系列必须经过的IP地址；

    - ⑤严格的源站路由（Strict Source Route），与宽松的源站路由类似，但是要求只能经过指定的这些地址，不能经过其他的地址。

- 填充
  - IP 数据报首部最后需用全0的填充字段补齐成为4字节的整数倍。



# 分类IP地址

- IP地址的概念

  - IP 地址就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围内惟一的标识符。

  - IP 地址现在由因特网名字与号码分配机构（Internet Corporation for Assigned Names and Numbers ，ICANN）进行分配。

  - 根据IP地址的长度不同，IP地址主要有两种版本：一是IPv4，长度为32bit；二是IPv6，长度为128bit。

  - 关于IP地址的编址方案

    - 分类的IP地址
      - 最基本的编址方法，在 1981 年通过了相应的标准协议。

    - 子网地址
      - 对最基本编址方法的改进，其标准[RFC 950]在 1985 年通过。

    - 超网（CIDR地址）
      - 比较新的无分类编址方法，1993 年提出后很快得到推广应用。

    - IPv6
      - 128bit的地址。

    - IPv4地址编制方案的演变过程
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092555.jpeg)

- IP地址的组成

  - IPv4

    - 目前使用的IPv4是由32bit组成，每8位为一组，中间采用点”.”隔开，分别形成IP地址的网络地址和主机地址部分。为了便于记忆，一般采用点分十进制记法 。

    - IPv4地址的两级结构
      - ![img](https://api2.mubu.com/v3/document_image/d85fc076-1412-4e8e-accc-ff803e2a948c-4644403.jpg)

    - 点分十进制标记法

      - 将32Bit的二进制数值转换成4个十进制数值

      - 每个十进制数值小于等于255

      - 4个十进制数值间用“.”隔开

      - 图示
        - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092600.jpeg)![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092604.jpeg)

    - 点分十进制标记法举例
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092610.jpeg)

  - IPv6 

    - IPv6是由128bit组成，每16位为一组，中间采用点”：”隔开。为便于记忆，一般采用冒分十六进制记法表示。

    - 如：68E6:8C64:FFFF:FFFF:0:1180:960A:FFF8

    - IPv6也有两部分组成：可变长度的类型前缀和其余部分

- IP地址的分类

  - 根据RFC1166的说明，IPv4的地址主要分为5类

    - A类地址
      - 用于主机数目非常多的大型或特大型网络。

    - B类地址
      - 用于中型到大型网络。

    - C类地址
      - 主要用于局域网。

    - D类地址
      - 用作多目广播，多址发送。

    - E类地址
      - 保留未用（作为实验地址）。

- 分类IP地址的特征

  - 图示
    - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092616.jpeg)

  - 根据网络地址中第一字节的取值范围，可以确定IP地址所属的类别

    - A类：1～126

    - B类：128 ～ 191

    - C类：192 ～ 223

    - D类：224 ～ 239

    - E类：240 ～ 255

  - IPv4地址的使用范围
    - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092620.jpeg)

- IP地址的定址准则

  - 网络地址在INTERNET中必须是唯一的，在相同网络地址范围内，主机地址也必须是唯一的

  - 网络地址不能是127，因为127地址用作本地回送地址

    - 为每台主机本地所有，仅代表本地主机，不能用来分配。

    - 一般使用127.0.0.1这个地址。

    - 含有网络号127的数据报不可能出现在网络上。

  - 网络地址部分和主机地址部分的每一位（Bit）不能全为0，也不能全为1

    - 网络地址 

      - 全为0，该地址代表当前网络（this），不能传送
        - 如：192.168.0.3为一台主机。而0.0.0.3代表当前网络（泛指）中主机地址为3的这台主机。

      - 全为1( 255)，广播地址（all）
        - 如：255.255.255.255用于本网广播，也叫有限广播。

    - 主机地址

      - 全为0 ，代表整个网络，即主机所连接的网络地址
        - 如192.168.0.3对应的网络为192.168.0.0

      - 全为1( 255) ，广播地址，代表网络上的所有主机
        - 如192.168.0.255表示连接在网络192.168.0上的所有主机

    - 可分配IP地址的分配方法
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092623.jpeg)

- IP地址的分配方案

  - RFC1466（公共网IP地址分配）
    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092630.jpeg)

  - RFC1918（专用网IP地址分配）

    - IP地址

      - 全局（公共）IP地址―――公共主机

      - 本地（专用）IP地址―――本地主机

    - RFC1918定义的专用IP地址如下：

      - 10.0.0.0 －10.255.255.255     1个A类地址

      - 172.16.0.0 －172.31.255.255     16个连续的B类地址

      - 192.168.0.0－192.168.255.255 256个连续的C类地址

    - 自动专用IP地址（APIPA）
      - 169.254.0.1-169.254.255.254 单个子网自动配置

- IP分配需注意的问题

  - 小型网络使用C类地址，中型网络使用B类地址，大型网络使用A类地址

  - 主机
    - 连接到同一网络中所有主机的IP地址共享同一netid

  - 路由器

    - 路由器可以连接多个物理网络

    - 每个连接都拥有自己的IP地址

    - 每个IP地址的netid应与连接网络的netid相同

- 编址实例（3个C类地址，一个B类地址）
  - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092637.jpeg)![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092640.jpeg)



# IP地址的规划

- 通常1P地址的规划可参照下面步骤进行：

  - （1）分析网络规模，明确网络中所拥有的网段数量以及每个网段中可能拥有的最大主机数。

  - （2）根据网络规模确定所需要的网络类别和每类网络的数量。

  - （3）确定使用公用地址、私有地址还是两者混用。

  - （4）根据可用的地址资源为每台主机指定IP地址并在主机上进行相应的配置，在配置地址之前，还要考虑地址分配的方式。（静态分配、动态分配）



# 子网划分

- 分类IP地址的面临的问题

  - 在ARPANET早期，IP地址的设计不够合理

    - IP地址空间的利用率有时很低

    - 给每个物理网络分配一个网络号使路由表变得太大，使网络的性能变坏

    - 两级IP地址不够灵活

- 划分子网的思想（从两级 IP 地址到三级 IP 地址 ） 

  - 三级的 IP 地址

    - 为解决上述问题，从 1985 年起在 IP 地址中又增加了一个“子网号字段”，使两级 IP 地址变成为三级 IP 地址。

    - 这种做法叫作划分子网(sub netting) 。划分子网已成为因特网的正式标准协议。

    - 图示
      - ![img](https://api2.mubu.com/v3/document_image/9776ae4e-2b86-448d-bd5a-3e1c0aeba642-4644403.jpg)

  - 划分子网的基本思路

    - 划分子网纯属一个单位内部的事情。

    - 从主机号借用若干个比特作为子网号 subnet-id。

    - 从其他网络发送给本单位主机的 IP 数据报，仍然根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。

    - 然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。

    - 最后就将 IP 数据报直接交付给目的主机。

    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092653.jpeg)

  - 子网划分(subnetting) 的优点

    - 实现更小的广播域，减少网络流量；

    - 更好的利用IP地址空间，提高网络性能；

    - 使不同物理空间的主机使用同一网络地址，简化管理；

    - 易于扩大地理范围。

- 划分子网的步骤

  - 确定能够对哪个具体的网络地址进行子网划分。

  - 根据现在所需的子网数以及每个子网中所包含的主机数，用主机号的一些比特位来表示子网。

  - 划分子网的个数和每个子网中包含主机个数的公式计算：
    - 假设子网号部分占用m个比特位数，主机号部分占用n个比特位数，那么子网数=2m个；每个子网包含主机数=2n-2台（不包含全0和全1的主机号）。



# 子网掩码

- 子网掩码的概念

  - 通过IP数据报的首部并不知道源主机或目的主机所连接的网络是否进行了子网划分。

  - 因为32位的IP地址本身以及IP数据报的首部都没有包含任何有关子网划分的信息。

  - 假定一个数据报（目的地址是128.9.15.1）已到达连接网络（ 128.9.0.0 ）的路由器R1，如何把它转发到子网（ 128.9.15.0 ）去呢？

  - 子网掩码的构成

    - 图示
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092717.jpeg)

    - 网络地址= (IP 地址) AND (子网掩码)
      - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092720.jpeg)

- A 类、B 类和 C 类 IP 地址的默认子网掩码
  - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092723.jpeg)

- 子网掩码的使用

  - 计算主机所在子网的子网地址
    - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092726.jpeg)![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092729.jpeg)

  - 规划子网

    - 【例5-2】

      - 某校园网从ISP获得B类地址202.240.0.0，现在根据需要划分为240个子网，问子网掩码应该设置为多少？这240个子网应如何划分？校园网未划分子网的结构如图5-29所示。 

      - 图5-29
        - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092734.jpeg)

      - 分析

        - 根据子网划分需求，原来的B类地址网络号部分占16比特，主机号部分占16比特，对应B类网络的默认子网掩码255.255.0.0。

        - 现在需要将原有的B类网络划分为240个子网， 因为27=128<240<256=28，则需要从原来的主机号部分至少借8比特来表示子网

        - 新的子网掩码由默认的子网掩码255.255.0.0变为255.255.255.0

        - 子网掩码中新增加的8个1对应IP地址中的子网号部分

      - 划分子网前后子网掩码的变化
        - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092740.jpeg)

      - B类网络子网划分结果（使用固定子网掩码）
        - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092742.jpeg)

      - 校园网划分子网后的结构
        - ![img](https://raw.githubusercontent.com/DaiDuncan/PicUploader/main/img3/20210530092746.jpeg)

    - 子网划分总结

      - 若使用较少位数的子网号，则每一个子网上可连接的主机数就较多。反之，若使用较多位数的子网号，则子网的数目较多但每个子网上可连接的主机数就较少。

      - 可根据网络的具体情况(一共需要划分多少个子网，每个子网中最多有多少个主机)来选择合适的子网掩码。

  - 计算子网掩码，子网个数，子网内主机数；计算子网地址，子网广播地址 

    - 【例5-3】如果将一个C类网络192.168.1.0划分为4个子网，请问：

      - ①新的子网掩码是多少？

        - 因为要划分为4个子网，而4=22（注：此处以工程应用为主，可以使用子网号部分全0或全1的子网，计算子网个数时不需要再减2），因此需要从主机号部分借用2个比特位表示相应子网，相应的子网掩码中由24个1增加为26个1。

        - 255.255.255.0→255.255.255.192

        - 图示
          - ![img](https://api2.mubu.com/v3/document_image/b7cfa22a-11cb-4133-8a19-582c72e6d315-4644403.jpg)

      - ②每个子网的主机数是多少？
        - 由于借用2位标识子网，因此剩余的表示主机的主机号部分只有8-2=6个比特位，所以每个子网的主机数=26-2=62台。 

      - ③每个子网的子网地址？子网广播地址？子网内主机IP地址范围？
        - 由于划分子网并不改变IP地址的网络号部分，因此整个网络中的IP地址前24比特保持不变，借用来表示子网的2个bit 位的变化形式有4种，分别是00，01，10，11，剩余的6个比特位表示主机，变化范围是（00 0000）2→（11 1111）2，因为主机号部分全为0对应的IP地址是一个子网地址，主机号部分全为1对应的IP地址是一个子网广播地址，因此每个子网内主机IP地址的主机号部分变化范围是（00 0001）2→（11 1110）2，对应的地址个数是26-2=62个。 

      - C类网络192.168.1.0 IP地址空间的变化情况
        - ![img](https://api2.mubu.com/v3/document_image/11821535-a3cb-4f9e-8002-8852b6bbecdf-4644403.jpg)

      - C类网络192.168.1.0的子网信息
        - ![img](https://api2.mubu.com/v3/document_image/dba58a9b-93b5-4a13-9a69-065b7693278f-4644403.jpg)

# 无类别域间路由地址（CIDR）

- 因特网发展面临的必须尽早解决的问题

  - B类地址在1992年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕！

  - 因特网主干网的路由表项目数量急剧增长（从几千个增长到几万个）。

  - 整个 IPv4 的地址空间最终将全部耗尽

- 无分类编址CIDR的出现

  - 在RFC1009变长子网掩码 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择CIDR (Classless Inter-Domain Routing)。

  - 1993年，RFC1517～1519、1520。

- CIDR地址的特点

  - CIDR地址不分类

    - CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

    - CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。

    - IP 地址从三级编址（使用子网掩码）又回到了两级编址。
      - ![img](https://api2.mubu.com/v3/document_image/7b9ccbb2-112a-4172-a326-bc08cbf29808-4644403.jpg)

    - CIDR 还使用“斜线记法”(slash notation)，即CIDR记法，表示IP地址中网络前缀的长度，如128.15.48.34/20。 

  - CIDR地址块

    - CIDR 将网络前缀都相同的连续的 IP 地址组成“CIDR地址块”。

    - 一个CIDR地址块由地址块的起始地址和地址块中的地址数来定义。

    - CIDR地址块举例

      - CIDR地址块128.15.48.0/20，则：

        - 地址块的起始地址： 128.15.48.0；

        - 地址块中共有 212个地址；

        - 地址块中的最小地址：128.15.48.0；

        - 地址块中的最大地址：128.15.63.255；

      - 地址块中全 0 和全 1 的主机号地址一般作为特殊地址使用，通常只使用在这两个地址之间的地址；

      - 地址块的长度也可以用子网掩码来表示；

      - CIDR地址块128.15.48.0/20的结构
        - ![img](https://api2.mubu.com/v3/document_image/9464cd4a-8084-4b8d-972c-c7f89bea314e-4644403.jpg)

- CIDR地址块的应用

  - 网络192.168.1.0和4个子网的IP地址范围

    - 表5-9![img](https://api2.mubu.com/v3/document_image/7b767efb-8006-406c-a0d9-49e7053162e9-4644403.jpg)

    - 根据表5-9及CIDR地址块的定义，可以将网络192.168.1.0和4个子网表示成CIDR地址块的形式

      - 网络：192.168.1.0/24

      - 子网0：192.168.1.0/26

      - 子网1：192.168.1.64/26

      - 子网2：192.168.1.128/26

      - 子网3：192.168.1.192/26

    - 大小CIDR地址块之间的变化关系
      - ![img](https://api2.mubu.com/v3/document_image/68c92e4d-db19-4f41-a483-0ecf0f33505c-4644403.jpg)

  - CIDR地址块的应用举例

    - 【例5-4】

      - 有4个/24地址块：212.56.132.0/24，212.56.133.0/24，212.56.134.0/24，212.56.135.0/24。请试着进行最大可能的聚合。

      - 分析
        - 将4个地址块的前缀都转换为二进制，看是否有相同的网络前缀存在。
          - ![img](https://api2.mubu.com/v3/document_image/3a402f9f-ffc5-4eab-8471-65bc6164079d-4644403.jpg)

    - 【例5-5】

      - 有两个CIDR地址块208.128/11和208.130.28/22。是否有哪一个地址块包含了另一个地址？如果有，请指出，并说明理由

      - 分析：地址块208.128/11的前缀为：11010000100

      - 地址块208.130.28/22的前缀为：11010000100 00010 000111

      - 可以看出它的前11位与208.128/11的前缀是一致的，所以208.128/11地址块包含了208.130.28/22这一地址块。

    - 【例5-6】
      - 5ppt 131～142



# 网络地址转换（NAT）

- 网络地址转换概述

  - RFC 1918为私有网络预留了3个IP地址块 

  - 图示
    - ![img](https://api2.mubu.com/v3/document_image/f42725e8-1d75-42a5-b241-caa9b935c0e7-4644403.jpg)

  - 上述3个范围内的地址不会在Internet上被分配，可在公司或企业内部自由使用。

  - 但任何以私有IP地址为目标的IP数据报都将被互联网路由器丢弃。

  - RFC 1631 IP地址翻译器（IP Network Address Translator，NAT）属于接入广域网(WAN)技术，是一种将私有（保留）地址转化为合法IP地址访问Internet的转换技术

  - 核心是将私有地址转换为可以在公网上被路由的公有IP地址，它被广泛应用于各种类型Internet接入方式和各种类型的网络中。

- NAT技术的作用

  - 借助于NAT，使用私有保留地址的内部网络通过路由器发送数据包时，私有地址被转换成合法的公用IP地址，一个局域网只需使用少量IP地址（甚至是1个）即可实现私有地址网络内所有计算机与Internet的通信需求。

  - 网络地址转换是将IP数据报报头中的IP地址转换为另一个IP地址的过程。

  - NAT主要用于实现私有网络访问公共网络的功能。这种通过使用少量的公有IP地址代表较多的私有IP地址的方式有助于减缓可用IP地址空间的枯竭。

  - NAT主要用于以下几种情况

    - （1）连接到Internet，但没有足够的合法地址分配给内部主机。

    - （2）更改到一个需要重新分配地址的ISP。

    - （3）有相同的IP地址的两个内部网络合并。

    - （4）想支持负载均衡（主机）。

  - NAT的几个相关术语

    - 内部局部地址（Inside Local IP address）
      - 指定内部网络的主机地址，全局唯一，但为私有地址。

    - 内部全局地址（Inside Global IP address）
      - 代表一个或更多内部IP到外部网络的合法IP。

    - 外部全局地址（Outside Global IP address）
      - 外部网络主机的合法IP。

    - 外部局部地址（Outside Local IP address）
      - 外部网络的主机地址，看起来是内部网络的私有地址。

    - 简单转换入口（Simple Translation Entry）
      - 映射IP地址到另一个地址的入口。

    - 扩展转换入口（Extended Translation Entry）
      - 映射IP地址和端口到另一个匹配的IP地址和端口的入口。

- NAT的工作原理

  - 外部主机向虚拟主机（定义为内部全局地址）通信

  - NAT路由器接受外部主机的请求并依据NAT表建立与内部主机的连接，把内部全局地址（目的地址）翻译成内部局部地址，并转发数据包到内部主机，内部主机接收包并作出响应。

  - NAT路由器再使用内部局部地址和端口查询数据表，根据查询到的外部地址和端口作出响应。

  - ISP使用NAT技术的结构
    - ![img](https://api2.mubu.com/v3/document_image/2706f329-2198-4626-b74e-994c84888e2b-4644403.jpg)![img](https://api2.mubu.com/v3/document_image/c2447c32-232e-4c52-9e91-2cbbb00286bc-4644403.jpg)

- NAT技术的实现方式

  - 静态转换

  - 动态转换

  - 端口多路复用