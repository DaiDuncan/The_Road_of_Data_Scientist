# I/O管理

- I/O设备分类

  - 按使用特性分：存储设备、人机交互设备(键盘等)、网络通信设备

  - 按信息交换单位分：字符设备、块设备

  - 按传输速率分：低速设备、中速设备、高速设备

  - 按共享属性分：独占设备、共享设备、**虚拟设备**

- I/O管理的功能：设备分配、设备处理、缓冲管理、设备独立性(无关性)

- I/O软件层次结构

  - ==硬件→中断处理程序→设备驱动器→设备独立性软件→用户层软件==

  - 中断处理程序

    - 中断处理是控制输入输出设备和内存与CPU之间数据传送的主要方式

    - I/O设备的中断服务程序代码与任何进程都没有关系，只与硬件有关

    - 中断过程：唤醒被阻塞的驱动程序进程→保护被中断进程的CPU环境→分析中断原因→进行中断处理→恢复被中断进程的现场

  - **设备驱动程序**

    - 所有与设备相关的代码放在设备驱动程序中，每一类设备都配置一个驱动程序

    - 接受来自上层的设备独立性软件的抽象请求，转换成设备控制器可接受的具体命令，发送给它并监督命令执行

    - 具体过程：将抽象要求转换为具体要求→检查I/O请求合法性→读出和检查设备状态→传送必要参数→设置工作方式→启动I/O设备

  - 设备独立性软件
    - 实现一般设备都需要的I/O功能，并向用户空间软件提供一个统一的接口

  - 用户层软件（例如SPOOLing系统）





# I/O控制方式

- 设备控制器的功能

  - ==接受和识别来自CPU的各种指令==

  - 实现CPU与设备控制器、设备与设备之间的数据交换

  - 记录设备的状态，以供CPU查询

  - 识别所控制的每个设备的地址

  - 实现CPU输出/输入数据的缓冲，并进行差错控制

- 程序直接控制方式

  又称为==轮询==、忙等

  - 优点：工作过程简单

  - 缺点：CPU利用率相当低

- **中断控制方式**

  - 优点：CPU和I/O设备并行工作，CPU只需接到中断信号后处理即可，利用率高

  - 缺点：需要硬件支持；每输入/输出一个设备都需要CPU中断

- ==DMA控制方式==@STM32嵌入式系统

  - 在外设和内存间开辟直接的数据交换通路，成批进行数据交换，不需要CPU干预

  - 特点：数据传输的基本单位是数据块；数据单向传输；仅在一次传送开始和结束时需要CPU干预，其他过程在控制器控制下完成

  - DMA控制器中的寄存器
    - 命令/状态寄存器CR、内存地址寄存器MAR、数据寄存器DR、数据计数器DC

  - 优点：设备和CPU并行工作；设备与内存的数据交换速度加快，且不需要CPU干预

  - 缺点：每台设备需要一个DMA控制器，不经济

- **通道控制方式**

  - 通道独立于CPU，有自己的运算和控制逻辑、指令系统，通过通道I/O指令控制I/O操作

  - 一个通道可控制多台设备；通道硬件简单，指令类型单一；没有自己的内存，通道指令存放在主存中

  - 优点：I/O操作独立、把CPU从输入/输出操作中解放出来、CPU和通道、通道和通道、各通道的外设间都并行工作

  - 缺点：需要更多硬件，成本高；适合大型数据交互场合

  - 字节多路通道
    - 用于连接多个慢速和中速设备，数据传送以字节为单位，每传送一个字节需要较长等待时间，故通道可以字节交叉方式轮流为多个设备提供服务，大幅提高通道利用率；数据宽度一般为单字节

  - 数组选择通道
    - 按数组方式进行数据传送，可以连接多台高速设备，但它只有一个分配型子通道，即同一时间只能控制一台设备进行数据传送；故通道利用率低

  - 数组多路通道
    - 含有多个非分配型子通道，具有很高的数据传输速率，且通道利用率高；按数组方式进行数据传送





# I/O核心子系统

- I/O调度：==确定一个好的顺序来执行I/O请求(用来改善计算机效率)==

- ==高速缓存与缓冲==

  - 缓冲：缓和CPU和设备速度不匹配的矛盾，提高了**并行性、系统吞吐量和设备利用率，降低了设备对CPU的中断频率**

  - 缓冲分类

    - 单缓冲：设备与处理器对缓冲区的操作是串行的

    - 双缓冲：适合设备输入输出速度与CPU处理数据速度大致相等的情况

    - 循环缓冲：把汗多个大小相等的缓冲区，用指针链接起来，最后一个缓冲区指向想第一个缓冲区

    - **缓冲池：由多个缓冲区组成，缓冲区可供多个进程共享，且既能用于输入又能用于输出**
      一般为四个工作缓冲区：收容输入数据、提取输入数据、收容输出数据、提取输出数据

  - 高速缓存：可以保存数据备份的高速存储器

  - 缓冲区与高速缓冲的区别：①高速缓存存放的是设备上数据的备份(即高速缓存上有的数据,设备中一定有)，而缓冲区存放的数据则不然②如果要访问的数据在高速缓存上没有，还是需要去访问低速设备；而缓冲区条件下，高速设备与低速设备间通信每次都经过缓冲区，不会直接访问低速设备

- 设备分配与回收

  - 一些数据结构
    - 设备控制表DCT、设备控制器控制表COCT、通道控制表CHCT、系统设备表SDT

  - 设备分配策略

    - 根据设备的使用性质
      - 独占设备(独占分配)、共享设备(共享分配)、虚拟设备(虚拟分配)

    - 设备分配算法：先来先服务、优先级高者优先

    - 设备分配的安全性(不发生进程死锁)

      - 静态分配：不会出现死锁，但设备利用率低

      - 动态分配：可能出现死锁，设备利用率高

        - 安全分配：每当进程发出I/O请求后就进入阻塞状态，直到I/O完成才被唤醒，不会发生死锁(破坏了请求和保持条件)，但进程推进缓慢

        - 不安全分配：允许进程发出I/O请求后继续运行，且可以继续发出请求，故可能出现一个进程同时操作多个设备的情况，使进程推进迅速，但有可能死锁

    - 设备独立性

      划线的3个是实现设备独立性的方法

      - 概念：应用程序独立于具体使用的物理设备，可提高设备分配的灵活性和设备利用率

      - 为了实现设备独立性，必须在设备驱动程序之上设置一层设备独立性软件，用来执行所有I/O设备的公用操作，并向用户层软件提供统一接口

      - 系统中需设置一张逻辑设备表LUT来进行逻辑设备到物理设备的映射，每个表项中都有逻辑设备名、物理设备名和设备驱动程序入口地址；

      - 当应用程序用逻辑设备名请求分配I/O设备时，为它分配相应的物理设备，并在LUT中建立一个表目，以后进程利用该逻辑设备名请求I/O操作时，就可以从LUT中得到物理设备名和驱动程序入口地址

    - 设备分配程序

      - 单通路I/O系统的设备分配

      - 多通路I/O系统的设备分配

    - 设备回收

  - 假脱机技术SPOOLing

    - 又称为排队转储技术、同时外设联机操作技术，是==低速输入输出设备与主机交换的一种技术，核心思想是以联机的方式得到脱机的效果==

    - SPOOLing系统组成
      - 输入井和输出井、输入缓冲区和输出缓冲区、输入进程和输出进程

    - SPOOLing系统特点
      - 提高了I/O技术、设备实际上并没有分配给任何进程、实现了虚拟设备功能、速度匹配技术

